<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒã‚¹ - Hiroshima AI Club</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Noto Sans JP Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans JP", Arial, sans-serif;
        background-color: #f5f5f5;
        color: #333;
        overflow: hidden;
      }

      /* Utility Classes */
      .flex {
        display: flex;
      }
      .flex-1 {
        flex: 1;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .justify-center {
        justify-content: center;
      }
      .h-screen {
        height: 100vh;
      }
      .w-full {
        width: 100%;
      }
      .h-full {
        height: 100%;
      }
      .relative {
        position: relative;
      }
      .absolute {
        position: absolute;
      }
      .hidden {
        display: none;
      }
      .block {
        display: block;
      }
      .bg-white {
        background-color: white;
      }
      .bg-gray-100 {
        background-color: #f5f5f5;
      }
      .bg-gray-50 {
        background-color: #f9f9f9;
      }
      .bg-blue-500 {
        background-color: #3b82f6;
      }
      .bg-blue-600 {
        background-color: #2563eb;
      }
      .bg-green-500 {
        background-color: #10b981;
      }
      .bg-green-600 {
        background-color: #059669;
      }
      .bg-red-500 {
        background-color: #ef4444;
      }
      .bg-red-600 {
        background-color: #dc2626;
      }
      .bg-gray-500 {
        background-color: #6b7280;
      }
      .bg-gray-600 {
        background-color: #4b5563;
      }
      .text-white {
        color: white;
      }
      .text-gray-800 {
        color: #1f2937;
      }
      .text-gray-600 {
        color: #4b5563;
      }
      .text-gray-700 {
        color: #374151;
      }
      .text-gray-500 {
        color: #6b7280;
      }
      .text-blue-500 {
        color: #3b82f6;
      }
      .text-blue-700 {
        color: #1d4ed8;
      }
      .text-green-800 {
        color: #166534;
      }
      .text-green-700 {
        color: #15803d;
      }
      .text-orange-800 {
        color: #9a3412;
      }
      .text-orange-700 {
        color: #c2410c;
      }
      .rounded {
        border-radius: 0.25rem;
      }
      .rounded-lg {
        border-radius: 0.5rem;
      }
      .rounded-md {
        border-radius: 0.375rem;
      }
      .shadow-lg {
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .shadow-md {
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .p-4 {
        padding: 1rem;
      }
      .p-6 {
        padding: 1.5rem;
      }
      .px-3 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      .mb-3 {
        margin-bottom: 0.75rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mr-4 {
        margin-right: 1rem;
      }
      .border {
        border: 1px solid #d1d5db;
      }
      .border-gray-300 {
        border-color: #d1d5db;
      }
      .border-gray-200 {
        border-color: #e5e7eb;
      }
      .border-blue-300 {
        border-color: #93c5fd;
      }
      .border-green-200 {
        border-color: #bbf7d0;
      }
      .border-orange-200 {
        border-color: #fed7aa;
      }
      .border-yellow-200 {
        border-color: #fef08a;
      }
      .rounded-full {
        border-radius: 50%;
      }
      .font-bold {
        font-weight: 700;
      }
      .font-semibold {
        font-weight: 600;
      }
      .font-medium {
        font-weight: 500;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .text-xs {
        font-size: 0.75rem;
      }
      .text-lg {
        font-size: 1.125rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
      .cursor-pointer {
        cursor: pointer;
      }
      .cursor-not-allowed {
        cursor: not-allowed;
      }
      .overflow-y-auto {
        overflow-y: auto;
      }
      .space-y-2 > * + * {
        margin-top: 0.5rem;
      }
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      .space-y-6 > * + * {
        margin-top: 1.5rem;
      }
      .max-h-40 {
        max-height: 10rem;
      }
      .max-h-60 {
        max-height: 15rem;
      }
      .w-96 {
        width: 24rem;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .backdrop-blur-sm {
        backdrop-filter: blur(4px);
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Custom styles */
      .btn {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-primary {
        background-color: #3b82f6;
        color: white;
      }
      .btn-primary:hover {
        background-color: #2563eb;
      }
      .btn-success {
        background-color: #10b981;
        color: white;
      }
      .btn-success:hover {
        background-color: #059669;
      }
      .btn-danger {
        background-color: #ef4444;
        color: white;
      }
      .btn-danger:hover {
        background-color: #dc2626;
      }
      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }
      .btn-secondary:hover {
        background-color: #4b5563;
      }

      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        outline: none;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .reservation-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      /* Leaflet container */
      .leaflet-container {
        height: 100%;
        width: 100%;
        z-index: 1;
      }

      .leaflet-control-container {
        z-index: 1000;
      }

      .leaflet-popup-content-wrapper {
        border-radius: 8px;
      }

      .leaflet-popup-content {
        margin: 8px 12px;
        font-size: 13px;
      }

      /* Location search dropdown */
      .location-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 5px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
      }

      .location-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }

      .location-item:hover {
        background-color: #f5f5f5;
      }

      .location-item:last-child {
        border-bottom: none;
      }

      /* Status indicators */
      .status-passed {
        background-color: #e5e7eb;
        color: #6b7280;
      }
      .status-current {
        background-color: #dbeafe;
        border-color: #93c5fd;
      }
      .status-pickup {
        background-color: #ecfccb;
        color: #166534;
      }
      .status-dropoff {
        background-color: #fed7aa;
        color: #9a3412;
      }

      /* Quick location buttons */
      .quick-location-btn {
        width: 100%;
        text-align: left;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background: #f9f9f9;
        transition: background-color 0.2s;
        cursor: pointer;
        font-size: 0.875rem;
      }

      .quick-location-btn:hover {
        background-color: #f3f4f6;
      }

      .pickup-btn:hover {
        background-color: #f0fdf4;
      }
      .dropoff-btn:hover {
        background-color: #fff7ed;
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .w-96 {
          width: 100%;
        }
        .flex {
          flex-direction: column;
        }
        .reservation-section {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Main App Container -->
    <div id="app">
      <!-- Main View (Bus Tracker) -->
      <div id="main-view" class="flex h-screen bg-gray-100">
        <!-- Map Area -->
        <div class="flex-1 relative">
          <div id="map" class="w-full h-full"></div>

          <!-- Current Time Display -->
          <div
            class="absolute"
            style="
              top: 1rem;
              left: 1rem;
              background: rgba(255, 255, 255, 0.95);
              backdrop-filter: blur(4px);
              padding: 1rem;
              border-radius: 0.5rem;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
              z-index: 1000;
            "
          >
            <div class="text-2xl font-bold text-gray-800">
              ğŸ• <span id="current-time">09:00</span>
            </div>
            <div id="next-stop-info" class="mt-2 text-sm text-gray-600 hidden">
              æ¬¡ã®åœç•™æ‰€: <span id="next-stop-text"></span>
            </div>
          </div>
        </div>

        <!-- Control Panel -->
        <div class="w-96 bg-white shadow-lg overflow-y-auto">
          <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              ğŸšŒ ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒã‚¹
            </h1>

            <!-- Reservation Button -->
            <div class="mb-6">
              <button id="reservation-btn" class="btn btn-primary w-full">
                ğŸ“ äºˆç´„ã™ã‚‹
              </button>
            </div>

            <!-- Current Reservations -->
            <div
              id="reservations-info"
              class="bg-gray-50 p-4 rounded-lg mb-6 hidden"
            >
              <h2 class="text-lg font-semibold text-gray-800 mb-3">
                äºˆç´„æƒ…å ± (<span id="reservation-count">0</span>ä»¶)
              </h2>
              <div
                id="reservations-list"
                class="space-y-2 max-h-40 overflow-y-auto"
              ></div>
            </div>

            <!-- Route Timeline -->
            <div id="route-info" class="bg-gray-50 p-4 rounded-lg mb-6 hidden">
              <h2 class="text-lg font-semibold text-gray-800 mb-3">
                é‹è¡Œäºˆå®š (<span id="route-count">0</span>åœç•™æ‰€)
              </h2>
              <div
                id="route-list"
                class="space-y-2 max-h-60 overflow-y-auto"
              ></div>
            </div>

            <!-- Simulation Controls -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h2 class="text-lg font-semibold text-gray-800 mb-3">
                ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
              </h2>
              <button id="simulate-btn" class="btn w-full mb-3" disabled>
                â–¶ é–‹å§‹
              </button>

              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  å€é€Ÿ: <span id="speed-value">1</span>x
                </label>
                <input
                  type="range"
                  id="speed-slider"
                  min="1"
                  max="10"
                  value="1"
                  class="w-full"
                />
              </div>

              <button id="reset-btn" class="btn btn-secondary w-full" disabled>
                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reservation View -->
      <div
        id="reservation-view"
        class="hidden h-screen bg-gray-50 overflow-y-auto"
      >
        <div class="max-w-2xl mx-auto px-4 py-8">
          <!-- Header -->
          <div class="reservation-section">
            <div class="flex items-center justify-between">
              <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                ğŸ“ ãƒã‚¹äºˆç´„
              </h1>
              <button
                id="back-btn"
                class="text-blue-500 font-medium cursor-pointer"
              >
                â† ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹
              </button>
            </div>
            <p class="text-gray-600 mt-2">
              ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒã‚¹ã®äºˆç´„ã‚’è¡Œã£ã¦ãã ã•ã„
            </p>
          </div>

          <!-- Reservation Form -->
          <form id="reservation-form">
            <div class="reservation-section space-y-6">
              <!-- User Information -->
              <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                  ğŸ‘¤ åˆ©ç”¨è€…æƒ…å ±
                </h2>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      ãŠåå‰ *
                    </label>
                    <input
                      type="text"
                      id="passenger-name"
                      class="form-input"
                      placeholder="å±±ç”°å¤ªéƒ"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      é›»è©±ç•ªå· *
                    </label>
                    <input
                      type="tel"
                      id="phone-number"
                      class="form-input"
                      placeholder="090-1234-5678"
                      required
                    />
                  </div>
                </div>
              </div>

              <!-- Pickup Location -->
              <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                  ğŸŸ¢ ä¹—è»Šåœ°
                </h2>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    å ´æ‰€ã‚’æ¤œç´¢ *
                  </label>
                  <div class="relative">
                    <input
                      type="text"
                      id="pickup-search"
                      class="form-input"
                      placeholder="åœ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: åºƒå³¶é§…ã€å¹³å’Œè¨˜å¿µå…¬åœ’ï¼‰"
                    />
                    <div
                      id="pickup-loading"
                      class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hidden"
                    >
                      ğŸ”„ æ¤œç´¢ä¸­...
                    </div>
                    <div
                      id="pickup-dropdown"
                      class="location-dropdown hidden"
                    ></div>
                  </div>
                  <div
                    id="pickup-selected"
                    class="mt-2 p-3 bg-green-50 border border-green-200 rounded-md hidden"
                  ></div>
                </div>
              </div>

              <!-- Dropoff Location -->
              <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                  ğŸŸ  é™è»Šåœ°
                </h2>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    å ´æ‰€ã‚’æ¤œç´¢ *
                  </label>
                  <div class="relative">
                    <input
                      type="text"
                      id="dropoff-search"
                      class="form-input"
                      placeholder="åœ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: åºƒå³¶ç©ºæ¸¯ã€ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ï¼‰"
                    />
                    <div
                      id="dropoff-loading"
                      class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hidden"
                    >
                      ğŸ”„ æ¤œç´¢ä¸­...
                    </div>
                    <div
                      id="dropoff-dropdown"
                      class="location-dropdown hidden"
                    ></div>
                  </div>
                  <div
                    id="dropoff-selected"
                    class="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-md hidden"
                  ></div>
                </div>
              </div>

              <!-- Time -->
              <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                  ğŸ• åˆ©ç”¨æ™‚åˆ»
                </h2>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    å¸Œæœ›ä¹—è»Šæ™‚åˆ»
                  </label>
                  <input
                    type="time"
                    id="reservation-time"
                    class="form-input"
                    value="09:00"
                    required
                  />
                  <p class="text-sm text-gray-500 mt-1">
                    â€»å®Ÿéš›ã®ä¹—è»Šæ™‚åˆ»ã¯é‹è¡ŒçŠ¶æ³ã«ã‚ˆã‚Šå‰å¾Œã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                  </p>
                </div>
              </div>

              <!-- Notice -->
              <div
                style="
                  background-color: #fef3c7;
                  border-color: #fbbf24;
                  border: 1px solid;
                  border-radius: 0.5rem;
                  padding: 1rem;
                "
              >
                <h3 class="font-semibold mb-2" style="color: #92400e">
                  âš ï¸ ã”æ³¨æ„äº‹é …
                </h3>
                <ul class="text-sm space-y-1" style="color: #b45309">
                  <li>â€¢ äºˆç´„ã¯å…ˆç€é †ã§ã™</li>
                  <li>â€¢ é‹è¡ŒçŠ¶æ³ã«ã‚ˆã‚Šæ™‚åˆ»ãŒå¤‰æ›´ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</li>
                  <li>â€¢ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯é‹è¡Œ1æ™‚é–“å‰ã¾ã§å¯èƒ½ã§ã™</li>
                  <li>â€¢ åº§å¸­ã«ã¯é™ã‚ŠãŒã‚ã‚Šã¾ã™</li>
                </ul>
              </div>

              <!-- Submit Buttons -->
              <div class="flex space-y-4" style="gap: 1rem">
                <button
                  type="button"
                  id="cancel-reservation"
                  class="flex-1 btn btn-secondary"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 btn btn-primary">
                  äºˆç´„ç¢ºå®š
                </button>
              </div>
            </div>
          </form>

          <!-- Quick Locations -->
          <div class="reservation-section">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">
              ğŸ“ ã‚ˆãä½¿ã‚ã‚Œã‚‹å ´æ‰€
            </h2>
            <div
              class="space-y-4"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem"
            >
              <div>
                <h3 class="font-medium text-gray-700 mb-2">ä¹—è»Šåœ°</h3>
                <div class="space-y-2">
                  <button
                    type="button"
                    class="quick-location-btn pickup-btn"
                    data-type="pickup"
                    data-name="åºƒå³¶é§…"
                    data-lat="34.3978"
                    data-lng="132.4757"
                  >
                    ğŸš‰ åºƒå³¶é§…
                  </button>
                  <button
                    type="button"
                    class="quick-location-btn pickup-btn"
                    data-type="pickup"
                    data-name="å¹³å’Œè¨˜å¿µå…¬åœ’"
                    data-lat="34.3955"
                    data-lng="132.4536"
                  >
                    ğŸ•Šï¸ å¹³å’Œè¨˜å¿µå…¬åœ’
                  </button>
                </div>
              </div>
              <div>
                <h3 class="font-medium text-gray-700 mb-2">é™è»Šåœ°</h3>
                <div class="space-y-2">
                  <button
                    type="button"
                    class="quick-location-btn dropoff-btn"
                    data-type="dropoff"
                    data-name="åºƒå³¶ç©ºæ¸¯"
                    data-lat="34.4361"
                    data-lng="132.9194"
                  >
                    âœˆï¸ åºƒå³¶ç©ºæ¸¯
                  </button>
                  <button
                    type="button"
                    class="quick-location-btn dropoff-btn"
                    data-type="dropoff"
                    data-name="ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«åºƒå³¶åºœä¸­"
                    data-lat="34.4965"
                    data-lng="132.5036"
                  >
                    ğŸ›’ ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«åºƒå³¶åºœä¸­
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // Application State
      class BusApp {
        constructor() {
          this.map = null;
          this.busMarker = null;
          this.routeLayer = null;
          this.center = [34.3853, 132.4553]; // åºƒå³¶å¸‚å‘¨è¾º
          this.busPosition = [...this.center];
          this.reservations = [];
          this.route = [];
          this.isRunning = false;
          this.currentTime = 540; // 9:00 AM in minutes
          this.speed = 1;
          this.currentRouteIndex = 0;
          this.simulationInterval = null;

          // Selected locations for reservation
          this.selectedPickupLocation = null;
          this.selectedDropoffLocation = null;

          this.init();
        }

        init() {
          this.loadReservations();
          this.initMap();
          this.bindEvents();
          this.updateUI();
        }

        // Initialize Leaflet Map
        async initMap() {
          try {
            this.map = L.map("map").setView(this.center, 13);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "Â© OpenStreetMap contributors",
            }).addTo(this.map);

            // Bus marker with custom icon
            const busIcon = L.divIcon({
              className: "bus-icon",
              html: '<div style="background: #ff4444; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸšŒ</div>',
              iconSize: [30, 30],
            });

            this.busMarker = L.marker(this.busPosition, {
              icon: busIcon,
            }).addTo(this.map);
            this.routeLayer = L.layerGroup().addTo(this.map);

            if (this.reservations.length > 0) {
              this.optimizeRoute();
            }
          } catch (error) {
            console.error("Failed to initialize map:", error);
          }
        }

        // Load reservations from localStorage
        loadReservations() {
          const saved = localStorage.getItem("busReservations");
          if (saved) {
            this.reservations = JSON.parse(saved);
          }
        }

        // Save reservations to localStorage
        saveReservations() {
          localStorage.setItem(
            "busReservations",
            JSON.stringify(this.reservations),
          );
        }

        // Bind event listeners
        bindEvents() {
          // View switching
          document
            .getElementById("reservation-btn")
            .addEventListener("click", () => this.showReservationView());
          document
            .getElementById("back-btn")
            .addEventListener("click", () => this.showMainView());
          document
            .getElementById("cancel-reservation")
            .addEventListener("click", () => this.showMainView());

          // Simulation controls
          document
            .getElementById("simulate-btn")
            .addEventListener("click", () => this.toggleSimulation());
          document
            .getElementById("reset-btn")
            .addEventListener("click", () => this.resetSimulation());
          document
            .getElementById("speed-slider")
            .addEventListener("input", (e) => this.setSpeed(e.target.value));

          // Reservation form
          document
            .getElementById("reservation-form")
            .addEventListener("submit", (e) => this.handleReservation(e));

          // Location search
          document
            .getElementById("pickup-search")
            .addEventListener("input", (e) =>
              this.handleLocationSearch(e, "pickup"),
            );
          document
            .getElementById("dropoff-search")
            .addEventListener("input", (e) =>
              this.handleLocationSearch(e, "dropoff"),
            );

          // Quick location buttons
          document.querySelectorAll(".quick-location-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => this.handleQuickLocation(e));
          });

          // Click outside to close dropdowns
          document.addEventListener("click", (e) => {
            if (!e.target.closest(".location-search-container")) {
              document
                .querySelectorAll(".location-dropdown")
                .forEach((dd) => dd.classList.add("hidden"));
            }
          });
        }

        // Show main view
        showMainView() {
          document.getElementById("main-view").classList.remove("hidden");
          document.getElementById("reservation-view").classList.add("hidden");
          this.updateUI();
        }

        // Show reservation view
        showReservationView() {
          document.getElementById("main-view").classList.add("hidden");
          document
            .getElementById("reservation-view")
            .classList.remove("hidden");
          this.resetReservationForm();
        }

        // Update UI elements
        updateUI() {
          this.updateTimeDisplay();
          this.updateReservationsDisplay();
          this.updateRouteDisplay();
          this.updateSimulationControls();
        }

        // Update current time display
        updateTimeDisplay() {
          document.getElementById("current-time").textContent = this.formatTime(
            this.currentTime,
          );

          const nextStopInfo = document.getElementById("next-stop-info");
          const nextStopText = document.getElementById("next-stop-text");

          if (
            this.route.length > 0 &&
            this.currentRouteIndex < this.route.length
          ) {
            const nextStop = this.route[this.currentRouteIndex];
            nextStopText.textContent = `${nextStop.type === "pickup" ? "ğŸŸ¢ ä¹—è»Š" : "ğŸŸ  é™è»Š"} (${this.formatTime(nextStop.time)})`;
            nextStopInfo.classList.remove("hidden");
          } else {
            nextStopInfo.classList.add("hidden");
          }
        }

        // Update reservations display
        updateReservationsDisplay() {
          const container = document.getElementById("reservations-info");
          const count = document.getElementById("reservation-count");
          const list = document.getElementById("reservations-list");

          count.textContent = this.reservations.length;

          if (this.reservations.length > 0) {
            container.classList.remove("hidden");
            list.innerHTML = this.reservations
              .map(
                (res, idx) => `
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium text-sm">
                                äºˆç´„ ${idx + 1} - ${this.formatTime(res.time)}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div>å‡ºç™ºåœ°: ${res.pickupLocation || `(${res.pickup.lat.toFixed(4)}, ${res.pickup.lng.toFixed(4)})`}</div>
                                <div>è¡Œãå…ˆ: ${res.dropoffLocation || `(${res.dropoff.lat.toFixed(4)}, ${res.dropoff.lng.toFixed(4)})`}</div>
                                <div class="flex gap-4 mt-1">
                                    <span class="px-2 py-1 rounded text-xs ${res.pickupPassed ? "bg-gray-200 text-gray-600" : "bg-green-100 text-green-800"}">
                                        ä¹—è»Š: ${res.pickupPassed ? "é€šéæ¸ˆã¿" : "æœªé€šé"}
                                    </span>
                                    <span class="px-2 py-1 rounded text-xs ${res.dropoffPassed ? "bg-gray-200 text-gray-600" : "bg-orange-100 text-orange-800"}">
                                        é™è»Š: ${res.dropoffPassed ? "é€šéæ¸ˆã¿" : "æœªé€šé"}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            container.classList.add("hidden");
          }
        }

        // Update route display
        updateRouteDisplay() {
          const container = document.getElementById("route-info");
          const count = document.getElementById("route-count");
          const list = document.getElementById("route-list");

          count.textContent = this.route.length;

          if (this.route.length > 0) {
            container.classList.remove("hidden");
            list.innerHTML = this.route
              .map((stop, idx) => {
                const isPassed = idx < this.currentRouteIndex;
                const isCurrent = idx === this.currentRouteIndex;

                let statusClass = "";
                if (isCurrent) statusClass = "status-current";
                else if (isPassed) statusClass = "status-passed";

                return `
                            <div class="p-3 rounded border ${statusClass}">
                                <div class="flex items-center justify-between">
                                    <div class="font-medium text-sm">
                                        ${idx + 1}. ${stop.type === "pickup" ? "ğŸŸ¢ ä¹—è»Š" : "ğŸŸ  é™è»Š"}
                                        ${isCurrent ? " (ç¾åœ¨åœ°)" : ""}
                                        ${isPassed ? " (é€šéæ¸ˆã¿)" : ""}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ${this.formatTime(stop.time)}
                                    </div>
                                </div>
                                ${
                                  stop.destination
                                    ? `
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${stop.type === "pickup" ? "è¡Œãå…ˆ" : "å‡ºç™ºåœ°"}: (${stop.destination.lat.toFixed(4)}, ${stop.destination.lng.toFixed(4)})
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        `;
              })
              .join("");
          } else {
            container.classList.add("hidden");
          }
        }

        // Update simulation controls
        updateSimulationControls() {
          const simulateBtn = document.getElementById("simulate-btn");
          const resetBtn = document.getElementById("reset-btn");
          const speedValue = document.getElementById("speed-value");

          const hasRoute = this.route.length > 0;

          simulateBtn.disabled = !hasRoute;
          resetBtn.disabled = !hasRoute;

          if (hasRoute) {
            simulateBtn.className = `btn w-full mb-3 ${this.isRunning ? "btn-danger" : "btn-success"}`;
            simulateBtn.textContent = this.isRunning ? "â¸ åœæ­¢" : "â–¶ é–‹å§‹";
          } else {
            simulateBtn.className = "btn w-full mb-3";
            simulateBtn.style.backgroundColor = "#d1d5db";
            simulateBtn.style.color = "#6b7280";
            simulateBtn.textContent = "â–¶ é–‹å§‹";
          }

          speedValue.textContent = this.speed;
        }

        // Format time from minutes to HH:MM
        formatTime(minutes) {
          const h = Math.floor(minutes / 60);
          const m = minutes % 60;
          return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}`;
        }

        // Convert time string to minutes
        timeToMinutes(timeStr) {
          const [h, m] = timeStr.split(":").map(Number);
          return h * 60 + m;
        }

        // Calculate distance between two points (simplified)
        calculateDistance(lat1, lng1, lat2, lng2) {
          const R = 6371; // Earth radius in km
          const dLat = ((lat2 - lat1) * Math.PI) / 180;
          const dLng = ((lng2 - lng1) * Math.PI) / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) *
              Math.cos((lat2 * Math.PI) / 180) *
              Math.sin(dLng / 2) *
              Math.sin(dLng / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c;
        }

        // Optimize route from reservations
        optimizeRoute() {
          if (this.reservations.length === 0) return;

          const stops = [];
          this.reservations.forEach((res) => {
            if (!res.pickupPassed) {
              stops.push({
                ...res.pickup,
                type: "pickup",
                time: res.time,
                resId: res.id,
                destination: res.dropoff,
                origin: res.pickup,
              });
            }
            if (!res.dropoffPassed) {
              stops.push({
                ...res.dropoff,
                type: "dropoff",
                time: res.time + 10,
                resId: res.id,
                destination: res.dropoff,
                origin: res.pickup,
              });
            }
          });

          // Sort by time
          stops.sort((a, b) => a.time - b.time);

          // Simple optimization: visit nearest stops first
          const optimized = [];
          let current = { lat: this.busPosition[0], lng: this.busPosition[1] };
          const remaining = [...stops];
          let currentTime = stops[0]?.time || 540;

          while (remaining.length > 0) {
            let nearest = 0;
            let minDist = Infinity;

            remaining.forEach((stop, idx) => {
              const dist = this.calculateDistance(
                current.lat,
                current.lng,
                stop.lat,
                stop.lng,
              );
              if (dist < minDist) {
                minDist = dist;
                nearest = idx;
              }
            });

            const nextStop = remaining.splice(nearest, 1)[0];
            const travelTime = Math.ceil((minDist / 30) * 60); // 30km/h assumption
            currentTime = Math.max(currentTime + travelTime, nextStop.time);
            nextStop.time = currentTime;
            optimized.push(nextStop);
            current = nextStop;
          }

          this.route = optimized;
          this.currentRouteIndex = 0;
          this.drawRoute();
          this.updateUI();
        }

        // Draw route on map
        drawRoute() {
          if (!this.map || !this.routeLayer) return;

          this.routeLayer.clearLayers();

          if (this.route.length > 0) {
            // Route line
            const points = this.route.map((r) => [r.lat, r.lng]);
            L.polyline(points, {
              color: "#3388ff",
              weight: 4,
              opacity: 0.7,
            }).addTo(this.routeLayer);

            // Stop markers
            this.route.forEach((stop, idx) => {
              const isPassed = idx < this.currentRouteIndex;
              const isCurrent = idx === this.currentRouteIndex;

              let backgroundColor = "#4CAF50"; // Green for pickup
              if (stop.type === "dropoff") backgroundColor = "#FF9800"; // Orange for dropoff
              if (isPassed) backgroundColor = "#9E9E9E"; // Gray for passed
              if (isCurrent) backgroundColor = "#2196F3"; // Blue for current

              const icon = L.divIcon({
                className: "stop-icon",
                html: `<div style="background: ${backgroundColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white;">${idx + 1}</div>`,
                iconSize: [24, 24],
              });

              L.marker([stop.lat, stop.lng], { icon })
                .bindPopup(
                  `${stop.type === "pickup" ? "ğŸŸ¢ ä¹—è»Š" : "ğŸŸ  é™è»Š"}: ${this.formatTime(stop.time)}${isPassed ? " (é€šéæ¸ˆã¿)" : ""}`,
                )
                .addTo(this.routeLayer);
            });
          }
        }

        // Toggle simulation
        toggleSimulation() {
          if (this.route.length === 0) return;

          this.isRunning = !this.isRunning;
          this.updateUI();

          if (this.isRunning) {
            this.startSimulation();
          } else {
            this.stopSimulation();
          }
        }

        // Start simulation
        startSimulation() {
          this.simulationInterval = setInterval(() => {
            this.currentTime += this.speed;

            if (this.currentRouteIndex < this.route.length) {
              const targetStop = this.route[this.currentRouteIndex];

              if (this.currentTime >= targetStop.time) {
                // Reached target stop
                this.busPosition = [targetStop.lat, targetStop.lng];
                this.busMarker.setLatLng(this.busPosition);

                // Update reservation status
                const updatedReservations = this.reservations.map((res) => {
                  if (res.id === targetStop.resId) {
                    if (targetStop.type === "pickup") {
                      return { ...res, pickupPassed: true };
                    } else if (targetStop.type === "dropoff") {
                      return { ...res, dropoffPassed: true };
                    }
                  }
                  return res;
                });

                this.reservations = updatedReservations;
                this.saveReservations();
                this.currentRouteIndex++;
              } else {
                // Interpolate movement
                if (this.currentRouteIndex > 0 || this.route.length > 0) {
                  const prevStop =
                    this.currentRouteIndex === 0
                      ? {
                          lat: this.center[0],
                          lng: this.center[1],
                          time: this.currentTime - 10,
                        }
                      : this.route[this.currentRouteIndex - 1];

                  const progress = Math.max(
                    0,
                    Math.min(
                      1,
                      (this.currentTime - prevStop.time) /
                        (targetStop.time - prevStop.time),
                    ),
                  );

                  const lat =
                    prevStop.lat + (targetStop.lat - prevStop.lat) * progress;
                  const lng =
                    prevStop.lng + (targetStop.lng - prevStop.lng) * progress;
                  this.busPosition = [lat, lng];
                  this.busMarker.setLatLng(this.busPosition);
                }
              }
            } else {
              // Simulation complete
              this.isRunning = false;
              this.stopSimulation();
            }

            this.drawRoute();
            this.updateUI();
          }, 1000);
        }

        // Stop simulation
        stopSimulation() {
          if (this.simulationInterval) {
            clearInterval(this.simulationInterval);
            this.simulationInterval = null;
          }
        }

        // Reset simulation
        resetSimulation() {
          this.stopSimulation();
          this.currentTime = this.route[0]?.time || 540;
          this.currentRouteIndex = 0;
          this.busPosition = [...this.center];
          this.busMarker.setLatLng(this.busPosition);
          this.isRunning = false;
          this.drawRoute();
          this.updateUI();
        }

        // Set simulation speed
        setSpeed(speed) {
          this.speed = parseInt(speed);
          this.updateUI();
        }

        // Handle reservation form submission
        handleReservation(e) {
          e.preventDefault();

          const passengerName = document
            .getElementById("passenger-name")
            .value.trim();
          const phoneNumber = document
            .getElementById("phone-number")
            .value.trim();
          const reservationTime =
            document.getElementById("reservation-time").value;

          if (!passengerName) {
            alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          if (!phoneNumber) {
            alert("é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          if (!this.selectedPickupLocation) {
            alert("ä¹—è»Šåœ°ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
          }
          if (!this.selectedDropoffLocation) {
            alert("é™è»Šåœ°ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
          }

          const newReservation = {
            id: Date.now(),
            passengerName,
            phoneNumber,
            pickup: {
              lat: this.selectedPickupLocation.latitude,
              lng: this.selectedPickupLocation.longitude,
            },
            dropoff: {
              lat: this.selectedDropoffLocation.latitude,
              lng: this.selectedDropoffLocation.longitude,
            },
            pickupLocation: this.selectedPickupLocation.displayName,
            dropoffLocation: this.selectedDropoffLocation.displayName,
            time: this.timeToMinutes(reservationTime),
            pickupPassed: false,
            dropoffPassed: false,
            createdAt: new Date().toISOString(),
          };

          this.reservations.push(newReservation);
          this.saveReservations();
          this.optimizeRoute();

          alert("äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚");
          this.showMainView();
        }

        // Reset reservation form
        resetReservationForm() {
          document.getElementById("reservation-form").reset();
          document.getElementById("reservation-time").value = "09:00";
          document.getElementById("pickup-selected").classList.add("hidden");
          document.getElementById("dropoff-selected").classList.add("hidden");
          this.selectedPickupLocation = null;
          this.selectedDropoffLocation = null;
        }

        // Handle location search with debouncing
        handleLocationSearch(e, type) {
          const query = e.target.value;
          const loadingElement = document.getElementById(`${type}-loading`);
          const dropdownElement = document.getElementById(`${type}-dropdown`);

          if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
          }

          if (query.length < 2) {
            dropdownElement.classList.add("hidden");
            return;
          }

          loadingElement.classList.remove("hidden");

          this.searchTimeout = setTimeout(async () => {
            try {
              const response = await fetch(
                `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=10&addressdetails=1&accept-language=ja`,
                {
                  headers: {
                    "User-Agent": "LocationSearchApp/1.0",
                  },
                },
              );

              const data = await response.json();
              this.displaySearchResults(data, type);
            } catch (error) {
              console.error("Search error:", error);
            } finally {
              loadingElement.classList.add("hidden");
            }
          }, 500);
        }

        // Display search results
        displaySearchResults(results, type) {
          const dropdownElement = document.getElementById(`${type}-dropdown`);

          if (results.length > 0) {
            dropdownElement.innerHTML = results
              .map(
                (location) => `
                        <div class="location-item" data-type="${type}" data-lat="${location.lat}" data-lng="${location.lon}" data-name="${location.display_name}">
                            <div style="font-weight: 500; color: #333; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                ğŸ“ ${location.display_name}
                            </div>
                            <div style="font-size: 12px; color: #999; font-family: monospace;">
                                ç·¯åº¦: ${parseFloat(location.lat).toFixed(6)}, çµŒåº¦: ${parseFloat(location.lon).toFixed(6)}
                            </div>
                        </div>
                    `,
              )
              .join("");

            // Add click handlers for search results
            dropdownElement
              .querySelectorAll(".location-item")
              .forEach((item) => {
                item.addEventListener("click", () => this.selectLocation(item));
              });

            dropdownElement.classList.remove("hidden");
          } else {
            dropdownElement.innerHTML =
              '<div style="padding: 20px; text-align: center; color: #666;">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            dropdownElement.classList.remove("hidden");
          }
        }

        // Select location from search results
        selectLocation(item) {
          const type = item.dataset.type;
          const lat = parseFloat(item.dataset.lat);
          const lng = parseFloat(item.dataset.lng);
          const name = item.dataset.name;

          const locationInfo = {
            latitude: lat,
            longitude: lng,
            displayName: name,
          };

          if (type === "pickup") {
            this.selectedPickupLocation = locationInfo;
            document.getElementById("pickup-search").value = name;
            document.getElementById("pickup-selected").innerHTML = `
                        <p class="text-sm font-medium text-green-800">é¸æŠã•ã‚ŒãŸä¹—è»Šåœ°:</p>
                        <p class="text-sm text-green-700">${name}</p>
                        <p class="text-xs text-green-600" style="font-family: monospace;">ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)}</p>
                    `;
            document
              .getElementById("pickup-selected")
              .classList.remove("hidden");
          } else {
            this.selectedDropoffLocation = locationInfo;
            document.getElementById("dropoff-search").value = name;
            document.getElementById("dropoff-selected").innerHTML = `
                        <p class="text-sm font-medium text-orange-800">é¸æŠã•ã‚ŒãŸé™è»Šåœ°:</p>
                        <p class="text-sm text-orange-700">${name}</p>
                        <p class="text-xs text-orange-600" style="font-family: monospace;">ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)}</p>
                    `;
            document
              .getElementById("dropoff-selected")
              .classList.remove("hidden");
          }

          document.getElementById(`${type}-dropdown`).classList.add("hidden");
        }

        // Handle quick location buttons
        handleQuickLocation(e) {
          const type = e.target.dataset.type;
          const name = e.target.dataset.name;
          const lat = parseFloat(e.target.dataset.lat);
          const lng = parseFloat(e.target.dataset.lng);

          const locationInfo = {
            latitude: lat,
            longitude: lng,
            displayName: name,
          };

          if (type === "pickup") {
            this.selectedPickupLocation = locationInfo;
            document.getElementById("pickup-search").value = name;
            document.getElementById("pickup-selected").innerHTML = `
                        <p class="text-sm font-medium text-green-800">é¸æŠã•ã‚ŒãŸä¹—è»Šåœ°:</p>
                        <p class="text-sm text-green-700">${name}</p>
                        <p class="text-xs text-green-600" style="font-family: monospace;">ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)}</p>
                    `;
            document
              .getElementById("pickup-selected")
              .classList.remove("hidden");
          } else {
            this.selectedDropoffLocation = locationInfo;
            document.getElementById("dropoff-search").value = name;
            document.getElementById("dropoff-selected").innerHTML = `
                        <p class="text-sm font-medium text-orange-800">é¸æŠã•ã‚ŒãŸé™è»Šåœ°:</p>
                        <p class="text-sm text-orange-700">${name}</p>
                        <p class="text-xs text-orange-600" style="font-family: monospace;">ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)}</p>
                    `;
            document
              .getElementById("dropoff-selected")
              .classList.remove("hidden");
          }
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new BusApp();
      });
    </script>
  </body>
</html>
